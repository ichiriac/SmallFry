(function($) {
    $.fn.popupForm = function(options) {
        
        var _self = this,
            settings = $.extend({
                dialogOptions: {
                        title: 'Adding Engine',
                        width: 550,
                        position: 'center',
                        beforeClose: function () {
                            $(this).remove();
                        }
                    },
                actionOnClick: function(){},
                controller: 'Engine',
                view: 'add',
                popupClass: 'popup_div'
            }, options),
            theClick = function (e, clickEvent) {
                e.preventDefault();
                
                settings.dialogOptions.position = [clickEvent.pageX, clickEvent.pageY];
                
                (settings.actionOnClick)(); //do the click action
                
                $('.'+settings.popupClass).dialog('close');
                var div = $('<div>', {
                    'class': settings.popupClass
                });
                $.get(WEBROOT + 'index.php/'+settings.controller+'/'+settings.view, function (data) {
                    div.html(data).dialog(settings.dialogOptions);
                    $('form', div).submit(function (e) {
                        e.preventDefault();
                        $.post(this.action, $(this).serialize(), function (ret_data) {
                            if ($.trim(ret_data) == 'saved') {
                                var agg_unit_popup = $('#agg_units_popup');
                                if(agg_unit_popup.length){
                                    agg_unit_popup.load(agg_unit_popup.data('url_to_load'));
                                }
                                else {
                                    window.location.reload();
                                }
                                div.dialog('close');
                            } else {
                                $('.errors', div).remove();
                                div.prepend(ret_data);
                            }
                        });
                        return false;
                    });
                });
                return false;
            };
            
        
        _self.bind({
            'popupForm': theClick,
            'click': function(e){
                $(this).trigger('popupForm', [e]); //pass the clickEvent in
            }
        });
        
        return _self;

    };
})(jQuery);