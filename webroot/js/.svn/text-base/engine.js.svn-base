$(function () {
    $(window).resize(function () {
        var width = $('.main').width();
        var top = $('.top').eq(0);
        var floating = $('#staying').show().width(width).children().css({
            background: '#e2dddd'
        });
        top.children().each(function (index, item) {
            $(floating[index]).width($(item).width());
        });
        $('#page').css({
            minWidth: (width + 50)
        });
    }).trigger('resize');
    
    var rows = $('.open').parent('tr');
    //LINE BY LINE EDITS    
    function lineByLine(){
        (function(rows){
            rows.each(function(i, item){
                var tr = $(item),
                    open = tr.children('.open').eq(0),
                    id = open.data('id'),
                    name = open.data('name');

                tr.popupForm({
                    dialogOptions: {
                        title: 'Editing ' + name,
                        width: 550,
                        beforeClose: function () {
                            tr.css({
                                backgroundColor: 'white'
                            });
                            $(this).remove();
                        },
                        buttons: {
                            Edit: function () {
                                $('.disabled').removeAttr('disabled')
                            },
                            Delete: function () {
                                var div = $('.popup_div');
                                if (confirm("Are you sure you want to delete " + name + "?")) {
                                    $.get(WEBROOT + 'index.php/Engine/delete/' + id, function (ret_data) {
                                        if ($.trim(ret_data) == 'deleted') {
                                            alert('Deleted Engine ' + name + '!');
                                            window.location.reload();
                                            div.dialog('close');
                                        } else {
                                            $('.errors', div).remove();
                                            div.prepend(ret_data);
                                        }
                                    });
                                }
                            },
                            'View Aggregation Units': function () {
                                var popup = $('<div>',{
                                       id: 'agg_units_popup'
                                    }).dialog({
                                       modal: true,
                                       closeOnEscape: false,
                                       width: 800,
                                       title: 'Aggregation Units for '+name,
                                       beforeClose: function(){
                                           popup.remove();
                                       }
                                   }).data('url_to_load', WEBROOT + 'index.php/AggregationUnit/popup/' + name);
                                $.get(WEBROOT + 'index.php/AggregationUnit/popup/' + name, function (ret_data) {
                                       popup.html(ret_data)
                                });
                            }
                        }
                    },
                    actionOnClick: function(){
                        tr.data('current-color', tr.css('backgroundColor')).css({
                            backgroundColor: '#ccc'
                        });
                    },
                    controller: 'Engine',
                    view: 'edit/'+id
                });
            });
        })(rows);
    }
    //create edit rows
    lineByLine();
    //END LINE BY LINE EDITS
    
    //ADD ENGINE
    $('.add-engine').popupForm();
    //END ADD ENGINE
    
    //MASS EDITS
    (function(){ // All in it's own scope
        if(rows.length <= 50){
            var manageRows = $('<a>', {
                html: 'Mass Edit', 
                'class':'mass-edit'
            });
            $('#changeHeader').append(manageRows);
            var saveRows = $('<a>', {
                html: 'Save Mass Edit', 
                'class':'mass-edit'
            });
            var massEdit = function(){
                var self = $(this);

                //close all open dialogs
                $('.popup_div ').dialog('close');

                // bind and unbinds
                rows.unbind('click popupForm'); 
                self.html('Exit Mass Edit');
                self.unbind('click', massEdit);
                self.bind('click', cancelMassEdit);
                $('.add-engine').hide(); //hide it so it cannot be clicked on

                saveRows.appendTo('#changeHeader'); 
                var saveRowsClick = function(){
                    var to_post = {},
                        self = $(this);

                    self.unbind('click', saveRowsClick);
                    $(rows).each(function(i, item){
                        if($(item).data('changed-row')){
                            $('.open', item).each(function(j, jtem){
                                var id = $(jtem).data('id');

                                if(to_post[id] === undefined) { // set if undefined
                                    to_post[id] = {};
                                }
                                var jtem_input = $('input', jtem).get(0);
                                if(!jtem_input.disabled) {  //only enabled inputs
                                    if(jtem_input.type == 'text'){
                                        to_post[id][jtem_input.name] = jtem_input.value;
                                    }
                                    else if(jtem_input.type == 'checkbox'){
                                        to_post[id][jtem_input.name] = jtem_input.checked ? 1 : 0;
                                    }
                                }
                            });
                        }
                    });

                    $.post(WEBROOT + 'index.php/Engine/mass_edit/', to_post, function(data){

                        //remove old data:
                        $('.changed-row').removeClass('changed-row');
                        $('tr[id^="row_"]').data('changed-row', false);
                        $('.error-row').removeClass('error-row');
                        $('.mass-errors').remove();
                        console.log(data);
                        if(data.length){
                            var errors = $('<div>', {
                                'class':'mass-errors'
                            });
                            for(var i in data){
                                if(i !== 'length'){
                                    var item = data[i],
                                        this_row = $('#row_'+i).addClass('error-row').data('changed-row', true);
                                    $('#staying').after(this_row);
                                    errors.prepend($('<div>',{ //puts it in reverse order as displayed on the screen
                                        html: "Row "+i+" errors: "
                                    }).append(item));
                                }
                            }
                            alert('Please fix the red rows (all other changed rows were saved)');
                            errors.dialog({
                                width: 400,
                                height: 425,
                                title: 'Errors',
                                beforeClose: function(){
                                    errors.remove();
                                }
                            });
                        }
                        else {
                            alert('All changed rows were saved!');
                        }
                        $('.open', rows.not('.error-row')).each(function(i, item){
                            if($('input:checkbox', item).length){
                                $(item).data('original', $('input', item).prop('checked') ? 1 : 0);
                            }
                            else {
                                $(item).data('original', $('input', item).val());
                            }
                        });
                        self.bind('click', saveRowsClick);
                    });

                };

                saveRows.bind('click', saveRowsClick);

                // create inputs:
                var input = $('<input>', {
                    size: 16
                });            
                $('.open', rows).each(function(i, item){
                    // save original data
                    $(item).data('original', item.innerText);
                    var this_input = input.clone(),
                        this_tr = $(item).parent('tr'),
                        this_data = $(item).data();

                    this_tr.get(0).id = "row_"+this_data.id;
                    this_tr.get(0).title = "Row "+this_data.id;

                    this_input.attr({
                       name: this_data.key,
                       value: (this_data.key == 'production' || this_data.key == 'tradingLive') ? 1 : this_data.original,
                       disabled: (this_data.key == 'lastRun' || this_data.key == 'lastIP') ? true : false,
                       type: (this_data.key == 'production' || this_data.key == 'tradingLive') ? 'checkbox' : 'text',
                       checked: (this_data.original == 1) ? true : false
                    });
                    this_tr.data('changed-row', false); 
                    this_input.bind('keyup change',function(){
                        //changed info in a cell
                       this_tr.data('changed-row', true); 
                       this_tr.addClass('changed-row');
                    });
                    $(item).html(this_input);
                });
                $(window).trigger('resize');

            };
            var cancelMassEdit = function(){
               var self = $(this);

               //remove extra button
               saveRows.remove();

               //binds and unbinds
               lineByLine(); //create line by line edits again
               self.html('Mass Edit');
               self.bind('click', massEdit);
               self.unbind('click', cancelMassEdit);
               $('.add-engine').show();

               //remove inputs
               $('.open', rows).each(function(i, item){
                    // save original data
                    original = $(item).data('original');
                    $(item).html(original);
                });
                $('.error-row').removeClass('error-row');
                $('.changed-row').removeClass('changed-row');
                $(window).trigger('resize');
            };
            manageRows.bind('click', massEdit);
        }
    })();
    //END MASS EDITS
    
    $('.headerChange').change(function () {
        window.location.href = WEBROOT + 'index.php/Engine/index/' + this.value;
    });
    
    $('form#changeHeader').submit(function () {
        var search = escape($('#search_me', this).val());
        var type = $('#type', this).val();
        if ($.trim(search).length > 0) {
            window.location = WEBROOT + 'index.php/Engine/search/' + search + '/' + type;
        } else {
            window.location = WEBROOT + 'index.php/Engine/index/' + type;
        }
        return false;
    });
    
    
});